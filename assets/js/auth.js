document.addEventListener("DOMContentLoaded", async function () {
    if (typeof supabase === "undefined") {
        console.error("ðŸš¨ Supabase SDK is not loaded. Check script order in gwflowai.html!");
        return;
    }

    const SUPABASE_URL = "https://auzqfsljjbcvlhbgtivm.supabase.co"; // Your Supabase URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1enFmc2xqamJjdmxoYmd0aXZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0MzU1NDYsImV4cCI6MjA1NTAxMTU0Nn0.P72hPH7m3VuNOy1lBe-lM0_Qr7c9A4TORjP16gK-eOE"; // Your Supabase Anon Key

    // Initialize Supabase
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("âœ… Supabase Initialized");

    // Function to clean up URL (removes #access_token)
    function cleanUrl() {
        if (window.location.hash.includes("access_token")) {
            console.log("ðŸ”„ Cleaning URL...");
            setTimeout(() => {
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                console.log("âœ… URL Cleaned:", newUrl);
            }, 1000); // Delayed cleanup to allow Supabase session processing
        }
    }

    // Function to generate PDF
    function generatePDF(lat, long, userEmail) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("Smart Bhujal - Location Report", 10, 20);
        doc.setFontSize(12);
        doc.text(`User: ${userEmail}`, 10, 40);
        doc.text(`Latitude: ${lat}`, 10, 50);
        doc.text(`Longitude: ${long}`, 10, 60);
        doc.text("Generated by Smart Bhujal", 10, 80);

        doc.save(`SmartBhujal_Location_Report.pdf`);
    }

    // Function to open Supabase Auth
    window.openSupabaseAuth = async function () {
        console.log("ðŸ”„ Opening Supabase Auth...");

        try {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: "google", 
                options: {
                    redirectTo: "https://www.smartbhujal.com/gwflowai.html"
                }
            });

            if (error) {
                console.error("ðŸš¨ Authentication Error:", error.message);
            } else {
                console.log("âœ… Supabase Auth Window Opened");
            }
        } catch (err) {
            console.error("ðŸš¨ Unexpected Error:", err);
        }
    };

    // Handle authentication state change
    supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === "SIGNED_IN") {
            console.log("âœ… User Logged In:", session.user.email);

            // Clean URL after successful login
            cleanUrl();

            const searchButton = document.getElementById("search-button");
            if (searchButton) {
                searchButton.innerText = `Welcome, ${session.user.email.split("@")[0]}`;
                searchButton.disabled = true;
            }

            // Get lat-long from input
            const latLongInput = document.getElementById("lat-long-input").value;
            const [lat, long] = latLongInput.split(",");

            if (!lat || !long) {
                console.error("ðŸš¨ Invalid Latitude & Longitude");
                alert("Please enter valid coordinates before logging in.");
                return;
            }

            // Generate the PDF
            generatePDF(lat.trim(), long.trim(), session.user.email);
        }
    });

    // Forcefully clean the URL if already logged in
    window.onload = async function () {
        const { data: session } = await supabase.auth.getSession();
        if (session?.session) {
            console.log("âœ… User already logged in:", session.session.user.email);
            cleanUrl();
        }
    };
});
